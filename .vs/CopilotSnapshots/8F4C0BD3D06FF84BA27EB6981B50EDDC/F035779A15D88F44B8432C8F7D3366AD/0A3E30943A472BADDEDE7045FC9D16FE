using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Data;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Models;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Helpers;
using System.IO;

namespace CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan
{
 public partial class MainForm : Form
 {
 private BookRepository _repo;
 private BindingList<Book> _books;
 private BindingSource _bs = new BindingSource();
 private Bitmap _bookPlaceholder;

 public MainForm()
 {
 InitializeComponent();
 _repo = new BookRepository();
 _bookPlaceholder = ImageHelper.CreateBookPlaceholder();
 ApplyStyles();
 LoadBooks();
 }

 private void ApplyStyles()
 {
 // Apply UI styling from helper
 UIHelper.StyleDataGridView(dgvBooks);
 UIHelper.StyleButton(btnAdd, true);
 UIHelper.StyleButton(btnEdit, true);
 UIHelper.StyleButton(btnDelete, false);
 UIHelper.StyleButton(btnImport, true);
 UIHelper.StyleButton(btnExport, true);
 UIHelper.StyleButton(btnClearSearch, false);
 UIHelper.StyleTextBox(txtSearch);
 }

 private void LoadBooks()
 {
 try
 {
 var list = _repo.GetAll();
 _books = new BindingList<Book>(list);
 _bs.DataSource = _books;
 dgvBooks.DataSource = _bs;
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("❌ Lỗi tải dữ liệu: " + ex.Message, "Lỗi");
 }
 }

 private void UpdateStatusCount()
 {
 toolStripStatusLabelCount.Text = $"📊 Tổng số sách: {_books?.Count ??0}";
 }

 private void TxtSearch_TextChanged(object sender, EventArgs e)
 {
 var q = txtSearch.Text?.ToLower() ?? "";
 if (string.IsNullOrWhiteSpace(q))
 {
 _bs.DataSource = _books;
 return;
 }
 var filtered = _books.Where(b => (b.Title ?? "").ToLower().Contains(q) || (b.Author ?? "").ToLower().Contains(q) || (b.Category ?? "").ToLower().Contains(q) || (b.Publisher ?? "").ToLower().Contains(q)).ToList();
 _bs.DataSource = new BindingList<Book>(filtered);
 }

 private void BtnClearSearch_Click(object sender, EventArgs e)
 {
 txtSearch.Text = "";
 _bs.DataSource = _books;
 }

 private void Dgv_SelectionChanged(object sender, EventArgs e)
 {
 if (dgvBooks.SelectedRows.Count ==0)
 {
 ClearDetails();
 return;
 }
 var b = dgvBooks.SelectedRows[0].DataBoundItem as Book;
 if (b == null) return;
 DisplayBookDetails(b);
 }

 private void ClearDetails()
 {
 lblDetailTitleValue.Text = "";
 lblDetailAuthorValue.Text = "";
 lblDetailCategoryValue.Text = "";
 lblDetailPublishValue.Text = "";
 lblDetailPublisherValue.Text = "";
 lblDetailPagesValue.Text = "";
 lblDetailAddedValue.Text = "";
 pbCover.Image = _bookPlaceholder;
 }

 private void DisplayBookDetails(Book b)
 {
 lblDetailTitleValue.Text = b.Title;
 lblDetailAuthorValue.Text = b.Author;
 lblDetailCategoryValue.Text = b.Category;
 lblDetailPublishValue.Text = b.PublishDate == DateTime.MinValue ? "N/A" : b.PublishDate.ToShortDateString();
 lblDetailPublisherValue.Text = b.Publisher;
 lblDetailPagesValue.Text = b.PageCount > 0 ? b.PageCount.ToString() : "N/A";
 lblDetailAddedValue.Text = b.AddedDate == DateTime.MinValue ? "N/A" : b.AddedDate.ToString("dd/MM/yyyy HH:mm");
 pbCover.Image = _bookPlaceholder;
 }

 private void BtnAdd_Click(object sender, EventArgs e)
 {
 var form = new Forms.AddEditBookForm();
 if (form.ShowDialog(this) == DialogResult.OK)
 {
 try
 {
 var id = _repo.Add(form.Book);
 form.Book.Id = id;
 _books.Add(form.Book);

 // Handle imported list if present
 if (form.Tag is List<Book> imported && imported.Count >0)
 {
 for (int i=1;i<imported.Count;i++)
 {
 var ib = imported[i];
 var iid = _repo.Add(ib);
 ib.Id = iid;
 _books.Add(ib);
 }
 MessageBox.Show($"✅ Thêm {imported.Count} sách thành công!", "Thành công");
 }
 else
 {
 MessageBox.Show("✅ Thêm sách thành công!", "Thành công");
 }
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("❌ Lỗi thêm sách: " + ex.Message, "Lỗi");
 }
 }
 }

 private void BtnEdit_Click(object sender, EventArgs e)
 {
 if (dgvBooks.SelectedRows.Count ==0)
 {
 MessageBox.Show("⚠️ Vui lòng chọn sách cần chỉnh sửa", "Thông báo");
 return;
 }

 var b = dgvBooks.SelectedRows[0].DataBoundItem as Book;
 var clone = new Book
 {
 Id = b.Id,
 Title = b.Title,
 Author = b.Author,
 Category = b.Category,
 PublishDate = b.PublishDate,
 Publisher = b.Publisher,
 PageCount = b.PageCount,
 AddedDate = b.AddedDate
 };

 var form = new Forms.AddEditBookForm(clone);
 if (form.ShowDialog(this) == DialogResult.OK)
 {
 try
 {
 _repo.Update(form.Book);
 var idx = _books.IndexOf(b);
 _books[idx] = form.Book;
 _bs.ResetBindings(false);
 MessageBox.Show("✅ Cập nhật sách thành công!", "Thành công");
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("❌ Lỗi cập nhật: " + ex.Message, "Lỗi");
 }
 }
 }

 private void BtnDelete_Click(object sender, EventArgs e)
 {
 if (dgvBooks.SelectedRows.Count ==0)
 {
 MessageBox.Show("⚠️ Vui lòng chọn sách để xóa", "Thông báo");
 return;
 }

 var result = MessageBox.Show($"⚠️ Xác nhận xóa {dgvBooks.SelectedRows.Count} sách?", "Xóa sách", MessageBoxButtons.YesNo, MessageBoxIcon.Question);
 if (result != DialogResult.Yes) return;

 try
 {
 var toDelete = new List<Book>();
 foreach (DataGridViewRow row in dgvBooks.SelectedRows)
 {
 var b = row.DataBoundItem as Book;
 if (b != null) toDelete.Add(b);
 }

 foreach (var b in toDelete)
 {
 _repo.Delete(b.Id);
 _books.Remove(b);
 }

 MessageBox.Show($"✅ Đã xóa {toDelete.Count} sách!", "Thành công");
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("❌ Lỗi xóa: " + ex.Message, "Lỗi");
 }
 }

 private void BtnImport_Click(object sender, EventArgs e)
 {
 var frm = new Forms.ImportForm();
 if (frm.ShowDialog(this) != DialogResult.OK) return;

 try
 {
 int count =0;
 foreach (var b in frm.ImportedBooks)
 {
 var id = _repo.Add(b);
 b.Id = id;
 _books.Add(b);
 count++;
 }
 MessageBox.Show($"✅ Nhập thành công {count} sách!", "Thành công");
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("❌ Lỗi nhập: " + ex.Message, "Lỗi");
 }
 }

 private void BtnExport_Click(object sender, EventArgs e)
 {
 using (var sfd = new SaveFileDialog())
 {
 sfd.Filter = "CSV files|*.csv|All files|*.*";
 sfd.FileName = "books_export.csv";
 if (sfd.ShowDialog(this) != DialogResult.OK) return;

 try
 {
 var sb = new StringBuilder();
 sb.AppendLine("ID,Tiêu đề,Tác giả,Thể loại,Ngày xuất bản,Nhà xuất bản,Số trang,Ngày thêm");
 foreach (var b in _books)
 {
 sb.AppendLine($"{b.Id},\"{b.Title}\",\"{b.Author}\",\"{b.Category}\",{b.PublishDate:yyyy-MM-dd},\"{b.Publisher}\",{b.PageCount},{b.AddedDate:yyyy-MM-dd HH:mm:ss}");
 }
 File.WriteAllText(sfd.FileName, sb.ToString(), Encoding.UTF8);
 MessageBox.Show($"✅ Xuất {_books.Count} sách thành công!\\n📁 Đường dẫn: {sfd.FileName}", "Thành công");
 }
 catch (Exception ex)
 {
 MessageBox.Show("❌ Lỗi xuất: " + ex.Message, "Lỗi");
 }
 }
 }
 }
}

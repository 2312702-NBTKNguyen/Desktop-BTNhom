using System;
using System.Collections.Generic;
using System.Linq;
using System.Windows.Forms;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Models;
using System.IO;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Data;

namespace CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Forms
{
 public partial class AddEditBookForm : Form
 {
 public Book Book { get; private set; }
 private bool _isEdit;
 public AddEditBookForm()
 {
 InitializeComponent();
 Book = new Book();
 _isEdit = false;
 dtAdded.Value = DateTime.Now;
 }
 public AddEditBookForm(Book book) : this()
 {
 Book = book;
 _isEdit = true;
 txtTitle.Text = book.Title;
 txtAuthor.Text = book.Author;
 txtCategory.Text = book.Category;
 dtPublish.Value = book.PublishDate == DateTime.MinValue ? DateTime.Now : book.PublishDate;
 txtPublisher.Text = book.Publisher;
 numPages.Value = book.PageCount;
 dtAdded.Value = book.AddedDate == DateTime.MinValue ? DateTime.Now : book.AddedDate;
 }

 private void btnOk_Click(object sender, EventArgs e)
 {
 Book.Title = txtTitle.Text;
 Book.Author = txtAuthor.Text;
 Book.Category = txtCategory.Text;
 Book.PublishDate = dtPublish.Value;
 Book.Publisher = txtPublisher.Text;
 Book.PageCount = (int)numPages.Value;
 Book.AddedDate = dtAdded.Value;
 DialogResult = DialogResult.OK;
 }

 private void btnImport_Click(object sender, EventArgs e)
 {
 using (var ofd = new OpenFileDialog())
 {
 ofd.Filter = "Text files|*.txt|All files|*.*";
 if (ofd.ShowDialog(this) != DialogResult.OK) return;
 try
 {
 var lines = File.ReadAllLines(ofd.FileName);
 var list = new List<Book>();
 foreach (var line in lines)
 {
 var parts = line.Split('|');
 if (parts.Length <6) continue;
 DateTime pd;
 DateTime.TryParse(parts[3], out pd);
 int pc =0;
 int.TryParse(parts[5], out pc);
 var b = new Book
 {
 Title = parts[0],
 Author = parts[1],
 Category = parts[2],
 PublishDate = pd,
 Publisher = parts[4],
 PageCount = pc,
 AddedDate = DateTime.Now
 };
 list.Add(b);
 }
 // Show preview in a simple dialog
 var preview = new Forms.ImportPreviewForm(list);
 if (preview.ShowDialog(this) == DialogResult.OK)
 {
 // On OK, add first item to form fields for editing/adding; store others in Tag for parent to process
 var first = list.FirstOrDefault();
 if (first != null)
 {
 txtTitle.Text = first.Title;
 txtAuthor.Text = first.Author;
 txtCategory.Text = first.Category;
 dtPublish.Value = first.PublishDate == DateTime.MinValue ? DateTime.Now : first.PublishDate;
 txtPublisher.Text = first.Publisher;
 numPages.Value = first.PageCount;
 dtAdded.Value = first.AddedDate;
 }
 this.Tag = list; // parent can access this.Tag to get imported list
 }
 }
 catch (Exception ex)
 {
 MessageBox.Show("Import error: " + ex.Message);
 }
 }
 }
 }
}

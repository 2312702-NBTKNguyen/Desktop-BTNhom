using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Data;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Models;
using System.IO;

namespace CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan
{
 public partial class MainForm : Form
 {
 private BookRepository _repo;
 private BindingList<Book> _books;
 private BindingSource _bs = new BindingSource();

 public MainForm()
 {
 InitializeComponent();
 _repo = new BookRepository();
 ApplyToolbarIcons();
 LoadBooks();
 }

 private void ApplyToolbarIcons()
 {
 btnAdd.Image = SystemIcons.Information.ToBitmap();
 btnAdd.ImageAlign = ContentAlignment.TopCenter;
 btnAdd.Text = "Thêm";
 btnEdit.Image = SystemIcons.Application.ToBitmap();
 btnEdit.ImageAlign = ContentAlignment.TopCenter;
 btnEdit.Text = "Sửa";
 btnDelete.Image = SystemIcons.Error.ToBitmap();
 btnDelete.ImageAlign = ContentAlignment.TopCenter;
 btnDelete.Text = "Xóa";
 btnImport.Image = SystemIcons.WinLogo.ToBitmap();
 btnImport.ImageAlign = ContentAlignment.TopCenter;
 btnImport.Text = "Nhập TXT";
 btnExport.Image = SystemIcons.Shield.ToBitmap();
 btnExport.ImageAlign = ContentAlignment.TopCenter;
 btnExport.Text = "Xuất CSV";
 }

 private void LoadBooks()
 {
 try
 {
 var list = _repo.GetAll();
 _books = new BindingList<Book>(list);
 _bs.DataSource = _books;
 dgvBooks.DataSource = _bs;
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("Error loading books: " + ex.Message);
 }
 }

 private void UpdateStatusCount()
 {
 toolStripStatusLabelCount.Text = $"Số sách: {_books?.Count ??0}";
 }

 private void TxtSearch_TextChanged(object sender, EventArgs e)
 {
 var q = txtSearch.Text?.ToLower() ?? "";
 if (string.IsNullOrWhiteSpace(q))
 {
 _bs.DataSource = _books;
 return;
 }
 var filtered = _books.Where(b => (b.Title ?? "").ToLower().Contains(q) || (b.Author ?? "").ToLower().Contains(q) || (b.Category ?? "").ToLower().Contains(q) || (b.Publisher ?? "").ToLower().Contains(q)).ToList();
 _bs.DataSource = new BindingList<Book>(filtered);
 }

 private void Dgv_SelectionChanged(object sender, EventArgs e)
 {
 if (dgvBooks.SelectedRows.Count ==0)
 {
 lblDetailTitleValue.Text = string.Empty;
 lblDetailAuthorValue.Text = string.Empty;
 lblDetailCategoryValue.Text = string.Empty;
 lblDetailPublishValue.Text = string.Empty;
 lblDetailPublisherValue.Text = string.Empty;
 lblDetailPagesValue.Text = string.Empty;
 lblDetailAddedValue.Text = string.Empty;
 pbCover.Image = null;
 return;
 }
 var b = dgvBooks.SelectedRows[0].DataBoundItem as Book;
 if (b == null) return;
 lblDetailTitleValue.Text = b.Title;
 lblDetailAuthorValue.Text = b.Author;
 lblDetailCategoryValue.Text = b.Category;
 lblDetailPublishValue.Text = b.PublishDate == DateTime.MinValue ? string.Empty : b.PublishDate.ToShortDateString();
 lblDetailPublisherValue.Text = b.Publisher;
 lblDetailPagesValue.Text = b.PageCount.ToString();
 lblDetailAddedValue.Text = b.AddedDate == DateTime.MinValue ? string.Empty : b.AddedDate.ToString();
 // optional: set a default cover
 pbCover.Image = Properties.Resources.book_placeholder;
 }

 private void BtnAdd_Click(object sender, EventArgs e)
 {
 var form = new Forms.AddEditBookForm();
 if (form.ShowDialog(this) == DialogResult.OK)
 {
 try
 {
 var id = _repo.Add(form.Book);
 form.Book.Id = id;
 _books.Add(form.Book);
 // Handle imported list if present
 if (form.Tag is List<Book> imported && imported.Count >0)
 {
 // skip first as it's already added into fields; add remaining
 for (int i=1;i<imported.Count;i++)
 {
 var ib = imported[i];
 var iid = _repo.Add(ib);
 ib.Id = iid;
 _books.Add(ib);
 }
 }
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("Error adding book: " + ex.Message);
 }
 }
 }

 private void BtnEdit_Click(object sender, EventArgs e)
 {
 if (dgvBooks.SelectedRows.Count ==0) { MessageBox.Show("Chọn sách cần sửa"); return; }
 var b = dgvBooks.SelectedRows[0].DataBoundItem as Book;
 var clone = new Book
 {
 Id = b.Id,
 Title = b.Title,
 Author = b.Author,
 Category = b.Category,
 PublishDate = b.PublishDate,
 Publisher = b.Publisher,
 PageCount = b.PageCount,
 AddedDate = b.AddedDate
 };
 var form = new Forms.AddEditBookForm(clone);
 if (form.ShowDialog(this) == DialogResult.OK)
 {
 try
 {
 _repo.Update(form.Book);
 var idx = _books.IndexOf(b);
 _books[idx] = form.Book;
 _bs.ResetBindings(false);
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("Error updating: " + ex.Message);
 }
 }
 }

 private void BtnDelete_Click(object sender, EventArgs e)
 {
 if (dgvBooks.SelectedRows.Count ==0) { MessageBox.Show("Chọn sách để xóa"); return; }
 if (MessageBox.Show($"Xóa {dgvBooks.SelectedRows.Count} sách?", "Xác nhận", MessageBoxButtons.YesNo) != DialogResult.Yes) return;
 try
 {
 var toDelete = new List<Book>();
 foreach (DataGridViewRow row in dgvBooks.SelectedRows)
 {
 var b = row.DataBoundItem as Book;
 if (b != null) toDelete.Add(b);
 }
 foreach (var b in toDelete)
 {
 _repo.Delete(b.Id);
 _books.Remove(b);
 }
 UpdateStatusCount();
 }
 catch (Exception ex)
 {
 MessageBox.Show("Error deleting: " + ex.Message);
 }
 }

 private void BtnImport_Click(object sender, EventArgs e)
 {
 var frm = new Forms.ImportForm();
 if (frm.ShowDialog(this) != DialogResult.OK) return;
 try
 {
 foreach (var b in frm.ImportedBooks)
 {
 var id = _repo.Add(b);
 b.Id = id;
 _books.Add(b);
 }
 UpdateStatusCount();
 MessageBox.Show("Import hoàn tất");
 }
 catch (Exception ex)
 {
 MessageBox.Show("Import error: " + ex.Message);
 }
 }

 private void BtnExport_Click(object sender, EventArgs e)
 {
 using (var sfd = new SaveFileDialog())
 {
 sfd.Filter = "CSV files|*.csv|All files|*.*";
 sfd.FileName = "books_export.csv";
 if (sfd.ShowDialog(this) != DialogResult.OK) return;
 try
 {
 var sb = new StringBuilder();
 sb.AppendLine("Id,Title,Author,Category,PublishDate,Publisher,PageCount,AddedDate");
 foreach (var b in _books)
 {
 sb.AppendLine($"{b.Id},\"{b.Title}\",\"{b.Author}\",\"{b.Category}\",{b.PublishDate:yyyy-MM-dd},\"{b.Publisher}\",{b.PageCount},{b.AddedDate:yyyy-MM-dd HH:mm:ss}");
 }
 File.WriteAllText(sfd.FileName, sb.ToString(), Encoding.UTF8);
 MessageBox.Show("Exported");
 }
 catch (Exception ex)
 {
 MessageBox.Show("Export error: " + ex.Message);
 }
 }
 }
 }
}

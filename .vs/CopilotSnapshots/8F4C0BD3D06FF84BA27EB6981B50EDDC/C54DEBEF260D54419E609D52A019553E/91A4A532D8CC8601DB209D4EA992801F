using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Data;
using CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan.Models;
using CTK47B_BaiTapNhom_ThuVienSachCaNhan = CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan; // alias to satisfy folder name
using System.IO;
using System.Diagnostics;

namespace CTK47B_BaiTapNhom_ThuVienQuanLySachCaNhan
{
 public partial class MainForm : Form
 {
 private BookRepository _repo;
 private BindingList<Book> _books;
 private BindingSource _bs = new BindingSource();

 public MainForm()
 {
 InitializeComponent();
 _repo = new BookRepository();
 InitializeLayoutComponents();
 LoadBooks();
 }

 private void InitializeLayoutComponents()
 {
 // Build top toolbar with buttons and images
 var pnlTop = new FlowLayoutPanel { Dock = DockStyle.Top, Height =100, Padding = new Padding(10) };

 var btnAdd = new Button { Text = "Add", Width =80, Height =80, ImageAlign = ContentAlignment.TopCenter, TextAlign = ContentAlignment.BottomCenter };
 btnAdd.Click += BtnAdd_Click;
 var btnEdit = new Button { Text = "Edit", Width =80, Height =80, ImageAlign = ContentAlignment.TopCenter, TextAlign = ContentAlignment.BottomCenter };
 btnEdit.Click += BtnEdit_Click;
 var btnDelete = new Button { Text = "Delete", Width =80, Height =80, ImageAlign = ContentAlignment.TopCenter, TextAlign = ContentAlignment.BottomCenter };
 btnDelete.Click += BtnDelete_Click;
 var btnImport = new Button { Text = "Import TXT", Width =100, Height =80 };
 btnImport.Click += BtnImport_Click;
 var btnExport = new Button { Text = "Export Excel", Width =100, Height =80 };
 btnExport.Click += BtnExport_Click;

 pnlTop.Controls.AddRange(new Control[] { btnAdd, btnEdit, btnDelete, btnImport, btnExport });
 this.Controls.Add(pnlTop);

 // Search panel
 var pnlSearch = new Panel { Dock = DockStyle.Top, Height =40, Padding = new Padding(10) };
 var txtSearch = new TextBox { Name = "txtSearch", Width =400 };
 txtSearch.TextChanged += TxtSearch_TextChanged;
 pnlSearch.Controls.Add(new Label { Text = "Search:", AutoSize = true, Location = new Point(10,10) });
 txtSearch.Location = new Point(70,8);
 pnlSearch.Controls.Add(txtSearch);
 this.Controls.Add(pnlSearch);

 // Main split (left grid, right details)
 var split = new SplitContainer { Dock = DockStyle.Fill, Orientation = Orientation.Vertical, SplitterDistance =500 };

 var dgv = new DataGridView { Name = "dgvBooks", Dock = DockStyle.Fill, ReadOnly = true, SelectionMode = DataGridViewSelectionMode.FullRowSelect, MultiSelect = true, AutoGenerateColumns = false };
 dgv.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Id", HeaderText = "ID", Width =50 });
 dgv.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Title", HeaderText = "Title", Width =200 });
 dgv.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Author", HeaderText = "Author", Width =150 });
 dgv.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "Category", HeaderText = "Category", Width =100 });
 dgv.Columns.Add(new DataGridViewTextBoxColumn { DataPropertyName = "PublishDate", HeaderText = "Publish", Width =100 });

 dgv.SelectionChanged += Dgv_SelectionChanged;
 split.Panel1.Controls.Add(dgv);

 // Right panel for details
 var pnlDetails = new Panel { Dock = DockStyle.Fill, Padding = new Padding(10) };
 var lblDetails = new Label { Text = "Details", Font = new Font(Font.FontFamily,10, FontStyle.Bold), Dock = DockStyle.Top, Height =25 };
 pnlDetails.Controls.Add(lblDetails);

 var txtDetails = new TextBox { Name = "txtDetails", Multiline = true, ReadOnly = true, Dock = DockStyle.Fill, ScrollBars = ScrollBars.Vertical };
 pnlDetails.Controls.Add(txtDetails);

 split.Panel2.Controls.Add(pnlDetails);

 this.Controls.Add(split);

 // Place controls order
 this.Controls.SetChildIndex(split,0);
 this.Controls.SetChildIndex(pnlSearch,1);
 this.Controls.SetChildIndex(pnlTop,2);

 // Set form properties
 this.Text = "Personal Book Library";
 this.WindowState = FormWindowState.Maximized;
 }

 private void LoadBooks()
 {
 try
 {
 var list = _repo.GetAll();
 _books = new BindingList<Book>(list);
 _bs.DataSource = _books;
 var dgv = this.Controls.Find("dgvBooks", true).FirstOrDefault() as DataGridView;
 dgv.DataSource = _bs;
 }
 catch (Exception ex)
 {
 MessageBox.Show("Error loading books: " + ex.Message);
 }
 }

 private void TxtSearch_TextChanged(object sender, EventArgs e)
 {
 var tb = sender as TextBox;
 var q = tb.Text?.ToLower() ?? "";
 if (string.IsNullOrWhiteSpace(q))
 {
 _bs.DataSource = _books;
 return;
 }
 var filtered = _books.Where(b => (b.Title ?? "").ToLower().Contains(q) || (b.Author ?? "").ToLower().Contains(q) || (b.Category ?? "").ToLower().Contains(q) || (b.Publisher ?? "").ToLower().Contains(q)).ToList();
 _bs.DataSource = new BindingList<Book>(filtered);
 }

 private void Dgv_SelectionChanged(object sender, EventArgs e)
 {
 var dgv = sender as DataGridView;
 var txt = this.Controls.Find("txtDetails", true).FirstOrDefault() as TextBox;
 if (dgv.SelectedRows.Count ==0)
 {
 txt.Text = string.Empty;
 return;
 }
 var b = dgv.SelectedRows[0].DataBoundItem as Book;
 if (b == null) return;
 txt.Text = $"ID: {b.Id}\r\nTitle: {b.Title}\r\nAuthor: {b.Author}\r\nCategory: {b.Category}\r\nPublish: {b.PublishDate:d}\r\nPublisher: {b.Publisher}\r\nPages: {b.PageCount}\r\nAdded: {b.AddedDate:g}";
 }

 private void BtnAdd_Click(object sender, EventArgs e)
 {
 var form = new Forms.AddEditBookForm();
 if (form.ShowDialog(this) == DialogResult.OK)
 {
 try
 {
 var id = _repo.Add(form.Book);
 form.Book.Id = id;
 _books.Add(form.Book);
 }
 catch (Exception ex)
 {
 MessageBox.Show("Error adding book: " + ex.Message);
 }
 }
 }

 private void BtnEdit_Click(object sender, EventArgs e)
 {
 var dgv = this.Controls.Find("dgvBooks", true).FirstOrDefault() as DataGridView;
 if (dgv.SelectedRows.Count ==0) { MessageBox.Show("Select a book to edit"); return; }
 var b = dgv.SelectedRows[0].DataBoundItem as Book;
 var clone = new Book {
 Id = b.Id, Title = b.Title, Author = b.Author, Category = b.Category, PublishDate = b.PublishDate, Publisher = b.Publisher, PageCount = b.PageCount, AddedDate = b.AddedDate
 };
 var form = new Forms.AddEditBookForm(clone);
 if (form.ShowDialog(this) == DialogResult.OK)
 {
 try
 {
 _repo.Update(form.Book);
 // update in list
 var idx = _books.IndexOf(b);
 _books[idx] = form.Book;
 _bs.ResetBindings(false);
 }
 catch (Exception ex)
 {
 MessageBox.Show("Error updating: " + ex.Message);
 }
 }
 }

 private void BtnDelete_Click(object sender, EventArgs e)
 {
 var dgv = this.Controls.Find("dgvBooks", true).FirstOrDefault() as DataGridView;
 if (dgv.SelectedRows.Count ==0) { MessageBox.Show("Select book(s) to delete"); return; }
 if (MessageBox.Show($"Delete {dgv.SelectedRows.Count} book(s)?","Confirm",MessageBoxButtons.YesNo) != DialogResult.Yes) return;
 try
 {
 var toDelete = new List<Book>();
 foreach (DataGridViewRow row in dgv.SelectedRows)
 {
 var b = row.DataBoundItem as Book;
 if (b!=null) toDelete.Add(b);
 }
 foreach(var b in toDelete)
 {
 _repo.Delete(b.Id);
 _books.Remove(b);
 }
 }
 catch (Exception ex)
 {
 MessageBox.Show("Error deleting: " + ex.Message);
 }
 }

 private void BtnImport_Click(object sender, EventArgs e)
 {
 using (var ofd = new OpenFileDialog())
 {
 ofd.Filter = "Text files|*.txt|All files|*.*";
 if (ofd.ShowDialog(this) != DialogResult.OK) return;
 try
 {
 var lines = File.ReadAllLines(ofd.FileName);
 foreach(var line in lines)
 {
 // expected CSV: Title|Author|Category|PublishDate(yyyy-MM-dd)|Publisher|PageCount
 var parts = line.Split('|');
 if (parts.Length <6) continue;
 var b = new Book{
 Title = parts[0], Author = parts[1], Category = parts[2], PublishDate = DateTime.Parse(parts[3]), Publisher = parts[4], PageCount = int.Parse(parts[5]), AddedDate = DateTime.Now
 };
 var id = _repo.Add(b);
 b.Id = id;
 _books.Add(b);
 }
 }
 catch (Exception ex)
 {
 MessageBox.Show("Import error: " + ex.Message);
 }
 }
 }

 private void BtnExport_Click(object sender, EventArgs e)
 {
 using (var sfd = new SaveFileDialog())
 {
 sfd.Filter = "CSV files|*.csv|All files|*.*";
 sfd.FileName = "books_export.csv";
 if (sfd.ShowDialog(this) != DialogResult.OK) return;
 try
 {
 var sb = new StringBuilder();
 sb.AppendLine("Id,Title,Author,Category,PublishDate,Publisher,PageCount,AddedDate");
 foreach(var b in _books)
 {
 sb.AppendLine($"{b.Id},\"{b.Title}\",\"{b.Author}\",\"{b.Category}\",{b.PublishDate:yyyy-MM-dd},\"{b.Publisher}\",{b.PageCount},{b.AddedDate:yyyy-MM-dd HH:mm:ss}");
 }
 File.WriteAllText(sfd.FileName, sb.ToString(), Encoding.UTF8);
 MessageBox.Show("Exported");
 }
 catch (Exception ex)
 {
 MessageBox.Show("Export error: " + ex.Message);
 }
 }
 }
 }
}
